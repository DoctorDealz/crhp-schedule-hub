<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CRHP Print Service</title>
    <style>
        /* 1. Hide everything by default */
        #output, .no-print { display: none; }

        /* 2. Throbber Logic */
        #throbber {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(241, 245, 249, 0.8);
            display: none; 
            flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999;
        }

        .data-ready #output, 
        .data-ready .no-print { display: block; }
        .data-ready #throbber { display: none !important; }

        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #cbd5e1;
            border-top-color: #38bdf8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .throbber-text { font-family: sans-serif; color: #334155; font-weight: bold; }

        :root {
            --accent: #38bdf8;
            --main-bg: #f0f9ff;
            --bg-lane-bg: #fdf4ff;
            --border: #cbd5e1;
            --text: #0f172a;
        }

        body { 
            font-family: "Segoe UI", Tahoma, sans-serif; 
            background: #f1f5f9; 
            color: #334155; 
            padding: 20px; 
            margin: 0;
            line-height: 1.4;
        }

        /* PRINT SPECIFIC FIXES */
        @media print {
            @page {
                size: letter landscape;
                margin: 0.3in;
            }
            body { padding: 0 !important; background: white !important; }
            
            /* Aggressive hiding of UI elements */
            .no-print, #throbber, button, input { 
                display: none !important; 
                visibility: hidden !important; 
                height: 0 !important; 
                margin: 0 !important; 
                padding: 0 !important;
            }

            .day-page { 
                width: 100% !important; 
                box-shadow: none !important; 
                margin: 0 0 20px 0 !important; 
                page-break-after: always; 
                break-after: page;
            }

            /* PREVENTS TASKS FROM CUTTING OFF */
            td {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            .task-container {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
        }

        .no-print { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); 
            max-width: 900px; 
            margin: 0 auto 30px auto; 
            border-left: 5px solid var(--accent); 
        }

        .day-page { 
            background: white; 
            width: 10.5in; 
            min-height: 7.5in; 
            padding: 0.3in; 
            margin: 0 auto 40px auto; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); 
            box-sizing: border-box; 
        }
        
        /* Larger Day Header */
        h1 { margin: 0; color: var(--text); font-size: 24pt; border-bottom: 3px solid var(--text); padding-bottom: 5px; }
        .day-num { font-size: 20pt; color: var(--accent); margin-bottom: 15px; font-weight: bold; }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            border: 2px solid var(--text);
        }

        .schedule-table th {
            background: #f8fafc;
            border: 1px solid var(--border);
            padding: 10px;
            text-align: center;
            font-size: 10pt;
            text-transform: uppercase;
            color: var(--text);
        }

        .schedule-table td {
            border: 1px solid var(--border);
            vertical-align: top;
            padding: 0;
        }

        .time-cell {
            text-align: center; 
            font-weight: bold; 
            background: #f8fafc; 
            padding: 10px !important;
            font-size: 10pt;
            color: #475569;
        }

        .task-container {
            padding: 8px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <div id="throbber">
        <div class="spinner"></div>
        <div class="throbber-text">SYNCING SCHEDULE DATA...</div>
    </div>

    <div class="no-print">
        <h2 style="margin-top:0">üñ®Ô∏è CRHP Schedule - Print Service</h2>
        <p style="font-size: 13pt; color: #464f5c; margin-bottom: 15px;">This can be used to upload a backup/export file from the scheduler/viewer to create an easily printable schedule.</p>
        <p style="font-size: 13pt; font-weight: bold; color: #464f5c; margin-bottom: 15px;">Note: After clicking Print/Save to PDF, choose horizontal print layout for best view.</p>
        <div style="display:flex; gap:10px; align-items:center;">
            <button onclick="window.print()" style="background:#0f172a; color:white; padding:12px 24px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">PRINT / SAVE PDF</button>
            <input type="file" id="manualFile" style="display:none" onchange="manualLoad(event)">
            <button onclick="document.getElementById('manualFile').click()" style="background:white; border:1px solid #cbd5e1; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold;">UPLOAD JSON</button>
            <button onclick="resetPrintView()" style="background:transparent; border:1px solid #f87171; color:#f87171; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold;">CLEAR PREVIEW</button>
        </div>
    </div>

    <div id="output"></div>

<script>
    localStorage.removeItem('crhp_print_exchange');

    window.onload = function() {
        const stored = localStorage.getItem('crhp_print_exchange');
        if (stored) forceRender(JSON.parse(stored));
        else showWaitingState();
    };

    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'PRINT_DATA') {
            const payload = event.data.payload;
            const throbberTimer = setTimeout(() => { document.getElementById('throbber').style.display = 'flex'; }, 200);
            requestAnimationFrame(() => {
                render(payload);
                clearTimeout(throbberTimer); 
                document.getElementById('throbber').style.display = 'none';
                if (window.opener) window.opener.postMessage('DATA_RECEIVED', '*');
                localStorage.setItem('crhp_print_exchange', JSON.stringify(payload));
            });
        }
    });

    function forceRender(payload) {
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                setTimeout(() => {
                    render(payload);
                    if (window.opener) window.opener.postMessage('DATA_RECEIVED', '*');
                    localStorage.setItem('crhp_print_exchange', JSON.stringify(payload));
                    document.body.classList.add('data-ready');
                }, 50); 
            });
        });
    }

    function showWaitingState() {
        document.body.classList.add('data-ready');
        document.getElementById('output').innerHTML = `
            <div class="no-print" style="text-align:center; padding:50px; color:#64748b; font-style:italic;">
                Waiting for data from the Viewer or a manual upload...
            </div>`;
    }

    function resetPrintView() {
        localStorage.removeItem('crhp_print_exchange');
        location.reload(); 
    }

    function manualLoad(e) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('throbber').style.display = 'flex';
        const reader = new FileReader();
        reader.onload = (event) => {
            setTimeout(() => {
                try {
                    const data = JSON.parse(event.target.result);
                    render(data);
                    localStorage.setItem('crhp_print_exchange', JSON.stringify(data));
                } catch(err) {
                    showError("Invalid JSON file.");
                }
                document.getElementById('throbber').style.display = 'none';
            }, 50);
        };
        reader.readAsText(file);
    }

    function showError(msg) {
        document.getElementById('output').innerHTML = `<div class="no-print" style="border-left-color:red">${msg}</div>`;
    }

    function getMinutes(timeVal) {
        if (typeof timeVal === 'number') return timeVal;
        if (typeof timeVal === 'string' && timeVal.includes(':')) {
            const timePart = timeVal.includes(' ') ? timeVal.split(' ')[1] : timeVal;
            const [h, m] = timePart.split(':').map(Number);
            return (h * 60) + m;
        }
        return 0;
    }

    function getDisplayTime(min) {
        let h = Math.floor(min / 60);
        const m = min % 60;
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        return `${h}:${m.toString().padStart(2, '0')} ${ampm}`;
    }

    function render(data) {
        let html = "";
        const totalDays = data.totalDays || data.days || 1;
        const allTasks = data.tasks || [];

        for (let d = 1; d <= totalDays; d++) {
            const dayTasks = allTasks.filter(t => t.day == d);
            if (dayTasks.length === 0) continue;

            dayTasks.forEach(t => t._assigned = false);

            const startMins = Math.min(...dayTasks.map(t => getMinutes(t.start)));
            const endMins = Math.max(...dayTasks.map(t => getMinutes(t.end)));
            const timeSlots = [];
            for (let i = startMins; i < endMins; i += 15) { timeSlots.push(i); }

            let maxMain = 1, maxBg = 1;
            timeSlots.forEach(slot => {
                const cMain = dayTasks.filter(t => (t.type||t.lane)==='main' && getMinutes(t.start) <= slot && getMinutes(t.end) > slot).length;
                const cBg = dayTasks.filter(t => (t.type||t.lane)==='bg' && getMinutes(t.start) <= slot && getMinutes(t.end) > slot).length;
                if (cMain > maxMain) maxMain = cMain;
                if (cBg > maxBg) maxBg = cBg;
            });

            const occupied = new Set();

            html += `<div class="day-page">
                <h1>CRHP Retreat Schedule</h1>
                <div class="day-num">Day ${d}</div>
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th style="width: 90px;">TIME</th>
                            <th colspan="${maxMain}">MAIN LANE</th>
                            <th colspan="${maxBg}">BACKGROUND LANE</th>
                        </tr>
                    </thead>
                    <tbody>`;

            timeSlots.forEach(slotTime => {
                html += `<tr><td class="time-cell">${getDisplayTime(slotTime)}</td>`;

                [['main', maxMain], ['bg', maxBg]].forEach(([laneType, totalCols]) => {
                    for (let col = 0; col < totalCols; col++) {
                        const cellKey = `${laneType}-${col}-${slotTime}`;
                        if (occupied.has(cellKey)) continue; 

                        const task = dayTasks.find(t => {
                            if (t._assigned || (t.type||t.lane) !== laneType) return false;
                            const tStart = getMinutes(t.start);
                            if (slotTime <= tStart && tStart < slotTime + 15) {
                                const dur = Math.max(1, Math.ceil((getMinutes(t.end) - tStart) / 15));
                                for (let i = 0; i < dur; i++) {
                                    if (occupied.has(`${laneType}-${col}-${slotTime + (i * 15)}`)) return false;
                                }
                                return true;
                            }
                            return false;
                        });

                        if (task) {
                            task._assigned = true;
                            const duration = Math.max(1, Math.ceil((getMinutes(task.end) - getMinutes(task.start)) / 15));
                            for (let i = 0; i < duration; i++) {
                                occupied.add(`${laneType}-${col}-${slotTime + (i * 15)}`);
                            }

                            const isBg = (task.type||task.lane) === 'bg';
                            const borderColor = isBg ? '#a855f7' : '#38bdf8';
                            const bgColor = isBg ? '#fdf4ff' : '#f0f9ff';

                            const cleanPeople = task.people ? task.people.map(p => {
                                const parts = p.split(' (');
                                const namePart = parts[0].trim();
                                const rolePart = parts[1] ? parts[1].replace(')', '').trim() : null;
                                return rolePart ? `${namePart} <span style="font-size: 0.9em; font-weight: 500; opacity: 0.8;">(${rolePart})</span>` : namePart;
                            }).join(', ') : '';

                            const hasMeta = !!(task.room || cleanPeople);
                            const metaTopBorder = hasMeta ? `border-top: 1px solid rgba(0,0,0,0.1); margin-top: 8px; padding-top: 6px;` : '';

                            html += `<td rowspan="${duration}" style="background: ${bgColor}; vertical-align: top; padding: 4px;">
                                <div class="task-container" style="border-left: 6px solid ${borderColor}; padding-left: 8px;">
                                    <div class="task-title" style="font-size: 11pt; font-weight: bold; margin-bottom: 2px;">${task.name}</div>
                                    <div class="task-time" style="font-size: 9pt; margin-bottom: 4px; opacity: 1;">
                                        ${getDisplayTime(getMinutes(task.start))} - ${getDisplayTime(getMinutes(task.end))}
                                    </div>
                                    ${task.desc ? `<div class="task-desc" style="font-size: 10pt; margin-bottom: 6px; font-style: italic;">${task.desc}</div>` : ''}
                                    
                                    <div class="task-meta" style="font-size: 13px; line-height: 1.3; color: #333; ${metaTopBorder}">
                                        ${task.room ? `<span style="font-weight: bold;">üìç ${task.room}</span>` : ''} 
                                        ${(task.room && cleanPeople) ? '<span style="margin: 0 4px; opacity: 0.8;">|</span>' : ''} 
                                        ${cleanPeople ? `<span style="display: inline-block;">üë• ${cleanPeople}</span>` : ''}
                                    </div>
                                </div>
                            </td>`;
                        } else {
                            html += `<td style="background: white;"></td>`;
                        }
                    }
                });
                html += `</tr>`;
            });

            html += `</tbody></table></div>`;
        }
        document.getElementById('output').innerHTML = html;
        document.getElementById('throbber').style.display = 'none';
        document.body.classList.add('data-ready');
    }
</script>
</body>
</html>
