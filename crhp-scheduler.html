<meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRHP Scheduler</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --accent: #38bdf8;
            --bg-task: #a855f7; --text: #f8fafc; --danger: #ef4444;
            --border: #475569; --now: #ff4747;
			--room: #f59e0b;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        body.modal-open { overflow: hidden; height: 100vh; }

        .fixed-top { padding: 15px; max-width: 600px; margin: 0 auto; background: var(--bg); }
        .section-title { font-size: 0.8rem; color: var(--accent); font-weight: bold; margin: 15px 0 5px; text-transform: uppercase; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #334155; margin-bottom: 15px; }
        
        .btn-row { display: flex; gap: 8px; margin-bottom: 20px; }
        .btn-ctrl { flex: 1; padding: 12px; font-size: 0.75rem; font-weight: bold; border-radius: 6px; border: 1px solid var(--border); background: #1e293b; color: #cbd5e1; cursor: pointer; }

        .day-container { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .day-btn { position: relative; padding: 8px 32px 8px 16px; border-radius: 20px; border: 1px solid #334155; background: #1e293b; color: white; cursor: pointer; white-space: nowrap; font-size: 0.8rem; display: flex; align-items: center; }
        .day-btn.active { background: var(--accent); color: #0f172a; border-color: var(--accent); font-weight: bold; }
        
        .checklist-toggle { background: #1e293b; border: 1px solid var(--accent); color: var(--accent); padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .checklist-toggle.active { background: var(--accent); color: #0f172a; }

        .day-delete-x { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--danger); font-size: 14px; font-weight: bold; }
        .day-add { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--accent); background: transparent; color: var(--accent); cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        input, textarea { width: 100%; padding: 12px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; }
        
        .roster-grid { display: grid; grid-template-columns: 1fr; gap: 2px; max-height: 180px; overflow-y: auto; background: #0f172a; padding: 4px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 10px; }
        .roster-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 6px; background: rgba(255,255,255,0.03); cursor: pointer; }
        .roster-item input[type="checkbox"] { width: 18px; height: 18px; margin: 0; accent-color: var(--accent); }
        .roster-item small, #rosterDisplay small { color: var(--accent); font-weight: bold; }

        .scroll-wrapper { 
            width: 100%; 
            overflow-x: auto; 
            border-top: 1px solid var(--border); 
        }

        .timeline-container { 
            position: relative; 
            width: 890px;      /* Your chosen "sweet spot" width */
            margin: 0 auto;    
            padding-right: 0; 
            box-sizing: border-box;
            background: var(--bg);
        }
        
        .checklist-container { max-width: 600px; margin: 20px auto; padding: 0 15px; display: none; }
        .check-item { background: var(--card); border: 1px solid #334155; border-radius: 12px; padding: 15px; margin-bottom: 10px; position: relative; cursor: pointer; padding-right: 20px; }
        .check-item.is-pending { border: 2px dashed var(--accent) !important; }
        .check-item.is-complete { opacity: 0.5; background: repeating-linear-gradient(45deg, rgba(30,41,59,1), rgba(30,41,59,1) 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px); }
        .check-item-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; display: block; padding-right: 65px; }
        .check-del { position: absolute; top: 12px; right: 15px; color: var(--danger); font-weight: bold; cursor: pointer; z-index: 10; font-size: 18px; }
        .check-status-row { position: absolute; right: 45px; top: 12px; display: flex; gap: 5px; }

        .main-node.is-pending { border: 2px dashed var(--accent) !important; }
        .bg-node.is-pending { border: 2px dashed var(--bg-task) !important; }
        .task-node.is-complete { opacity: 0.5; background: repeating-linear-gradient(45deg, rgba(30,41,59,1), rgba(30,41,59,1) 10px, rgba(255,255,255,0.05) 10px, rgba(255,255,255,0.05) 20px) !important; }

        .status-header-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0px; }
        .status-toggles { display: flex; gap: 3px; background: rgba(0,0,0,0.2); padding: 2px; border-radius: 4px; flex-shrink: 0; }
        .tiny-toggle { width: 18px; height: 18px; border: 1px solid white; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; transition: 0.1s; background: rgba(0,0,0,0.4); color: white; cursor: pointer; }
        .tiny-toggle.active { background: white; color: black; }

        .v-line { position: absolute; top: 0; bottom: 0; width: 1px; background: var(--border); z-index: 40; pointer-events: none; }
        .l-80 { left: 60px; }
        .l-430 { left: 410px; }
        .l-510 { left: 490px; }
        .l-860 { left: 840px; }

        .lane-header { position: absolute; top: 0; display: flex; z-index: 30; background: var(--bg); height: 35px; align-items: center; border-bottom: 1px solid var(--border); font-size: 0.75rem; font-weight: bold; }
        .header-main { left: 60px; width: 350px; justify-content: center; color: var(--accent); }
        .header-bg { left: 490px; width: 350px; justify-content: center; color: var(--bg-task); }

        .time-gutter { 
            position: absolute; 
            top: 0; 
            width: 60px; 
            bottom: 0; 
            background: var(--bg); /* Ensure this matches your background color exactly */
            z-index: 30; /* Higher than both hour-lines and now-line */
        }
        .left-gutter { left: 0; }
        .center-gutter { 
            left: 410px; /* (60 gutter + 350 main) */
            width: 80px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 30;
            background: var(--bg);
        }

        .hour-mark { 
            position: absolute; 
            left: 0;
            right: 0;
            width: 100%;
            text-align: center; /* This centers text inside a full-width block */
            transform: translateY(-50%); 
            /* Remove any left: 50% or translate(-50%) if using this method */
            font-size: 9px; 
            font-weight: bold; 
            color: #cbd5e1; 
        }

		.ultra-compact-text {
			line-height: 1;
			display: flex;
			align-items: center;
			gap: 4px;
		}
		.uc-count { color: var(--accent); font-weight: bold; } /* Assigned amount color */
		.uc-room { color: var(--room); font-weight: bold; }  /* Room color */
        
        .now-time-indicator { 
            position: absolute; 
            right: 2px; 
            color: var(--now); 
            font-size: 10px; 
            font-weight: bold; 
            transform: translateY(-40%); 
            z-index: 110; 
            padding: 0px 2px; 
            background: rgba(15, 23, 42, 0.70); 
            border-radius: 3px; 
        }
        
        .hour-line { 
            position: absolute; 
            left: 60px;  
            width: 780px; /* (Main 350) + (Center 80) + (BG 350) */
            height: 1px; 
            background: rgba(255, 255, 255, 0.12); 
            pointer-events: none; 
            z-index: 5; 
        }

        .hour-line.major { background: rgba(255, 255, 255, 0.3); }

        #nowLine { 
            position: absolute; 
            left: 60px;   /* Start after the left gutter */
            width: 780px; /* Exact width of Main + Center + BG lanes */
            height: 0px; 
            background: transparent; 
            border-top: 2.5px dashed rgba(255, 71, 71, 0.7);
            z-index: 20;  /* Higher than hour-lines, lower than gutters */
            pointer-events: none; 
            display: none; 
            box-shadow: 0 0 5px rgba(255, 71, 71, 0.8); 
        }

        .task-node {
            position: absolute; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; box-sizing: border-box;
            border: 1px solid rgba(255,255,255,0.1); border-left: 5px solid; cursor: pointer; z-index: 5;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .main-node { border-left-color: var(--accent); background: #1e2d45; }
        .bg-node { border-left-color: var(--bg-task); background: #281e45; }
        
        .task-title { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0; line-height: 1.2; }
        .task-meta {
			display: flex;
			flex-direction: column;
			justify-content: flex-start;
			overflow: hidden;
		}
        .crew-list { font-size: 8px; opacity: 0.95; line-height: 1.1; margin-top: 2px; }
		
		select {
			font-family: -apple-system, BlinkMacSystemFont, sans-serif; /* Matches body font */
			font-size: 14px;
			font-weight: 500;
			color: var(--text);
			background-color: #0f172a;
			border: 1px solid #334155;
			padding: 10px;
			border-radius: 6px;
			appearance: none; /* Removes default browser arrow for a cleaner look */
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2338bdf8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: right 10px center;
			background-size: 16px;
		}

		/* 2. Style the 'No Room Assigned' and other options */
		select option {
			font-family: -apple-system, sans-serif;
			background: #1e293b; /* Matches your card color */
			color: white;
		}

		/* 3. Specific fix for the 'No Room Assigned' text specifically */
		#taskRoom option[value=""], 
		#editTaskRoom option[value=""] {
			color: #94a3b8; /* Give the 'No Room' option a slightly muted/grey color */
			font-style: italic;
		}
		
		.room-label { color: var(--room); font-weight: bold; }
		.task-title .room-label { margin-left: 5px; font-size: 0.85em; }
        
        .main-node .crew-list small, .checklist-container .crew-list small { color: var(--accent); font-weight: bold; }
        .bg-node .crew-list small { color: var(--bg-task); font-weight: bold; }
        .assigned-label { font-weight: bold; text-transform: uppercase; font-size: 7px; display: block; }
        .main-node .assigned-label, .checklist-container .assigned-label { color: var(--accent); }
        .bg-node .assigned-label { color: var(--bg-task); }
        
        .time-range { font-size: 8px; opacity: 0.7; font-weight: bold; line-height: 1; margin-bottom: 2px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; }

        /* 1. First, make sure the overlay (background) is scrollable */
        #taskModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            z-index: 9999;
            overflow-y: auto; /* This enables the "page" scroll */
            padding: 20px 0 200px 0;   /* Gives space at top/bottom when scrolling */
        }

        /* 2. Update the modal-content to remove the centering anchor */
        .modal-content {
            position: relative; /* Change from fixed to relative */
            margin: 0 auto 40px auto;    /* Centers horizontally */
            background: var(--card);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--accent);
            width: 88%;
            max-width: 400px;
            /* Remove top/left/transform */
            /* Remove max-height/overflow-y here so the WHOLE modal scrolls */
        }

        .modal-cancel-x { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #94a3b8; font-size: 20px; font-weight: bold; cursor: pointer; }
        .toggle-btn { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #334155; background: none; color: #94a3b8; font-weight: bold; cursor: pointer; }
        .toggle-btn.active-main { border-color: var(--accent); color: var(--accent); background: rgba(56, 189, 248, 0.1); }
        .toggle-btn.active-bg { border-color: var(--bg-task); color: var(--bg-task); background: rgba(168, 85, 247, 0.1); }
		
		@media (min-width: 1024px) {
		body {
			zoom: 1.7; /* Automates the 170% zoom you've been doing manually */
			}
		.fixed-top {
			max-width: 1000px; /* Wider headers for desktop */
			}
		}

        /* Styling for the read-only instructions area */
        .help-content {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            padding: 15px;
            max-height: 350px;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #cbd5e1;
            border: 1px solid #334155;
        }

        .help-content b { color: var(--accent); }
        .help-content ul { padding-left: 20px; margin: 10px 0; }
        .help-content li { margin-bottom: 8px; }

        /* Help Button (Circle) */
        .btn-help {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 1px solid var(--accent);
            /* Change background from 0.1 to transparent */
            background: transparent; 
            color: var(--accent);
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            /* Add transition so it matches the link button's smoothness */
            transition: background 0.2s;
        }

        /* Add this new hover state */
        .btn-help:hover {
            background: rgba(56, 189, 248, 0.1);
        }

        /* Link Button Style */
        .btn-link {
            width: 42px;
            height: 42px;
            border-radius: 50%; /* Matches the help button shape */
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none; /* Removes underline from <a> tag */
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .btn-link:hover {
            background: rgba(56, 189, 248, 0.1);
        }

        /* Icon sizing */
        .btn-link svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .btn-home {
            width: 42px;
            height: 42px;
            border-radius: 50%; /* Matches the help button shape */
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none; /* Removes underline from <a> tag */
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .btn-home:hover {
            background: rgba(56, 189, 248, 0.1);
        }


        .btn-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0; /* Prevents the circle from squishing */
        transition: all 0.2s ease;
        }

        .btn-print {
            width: 42px;
            height: 42px;
            border-radius: 50%; /* Matches the help button shape */
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none; /* Removes underline from <a> tag */
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .btn-print:hover {
            background: rgba(56, 189, 248, 0.1);
        }

        #custom-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(7, 10, 15, 0.8); /* Darker overlay for better focus */
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(8px); /* Stronger blur for "Glass" look */
        }

        .modal-box {
            background: #1e293b; /* Deep slate background */
            padding: 24px;
            border-radius: 16px;
            width: 95%; max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle edge highlight */
            border-top: 4px solid var(--accent); /* Your signature blue line */
        }

        /* Modal Typography */
        .modal-box h3 { 
            margin: 0 0 12px 0; 
            color: #f8fafc; /* Crisp white for the title */
            font-size: 1.4rem;
        }

        .modal-box p { 
            color: #cbd5e1; /* Light slate for readable body text */
            margin-bottom: 24px; 
            line-height: 1.6;
            font-size: 1rem;
        }

        /* Buttons */
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }

        .modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        /* Primary Button (Confirm) */
        .btn-primary { 
            background: var(--accent); 
            color: #0f172a; /* Dark text on light blue background for pop */
            border: none; 
        }
        .btn-primary:hover { 
            background: #7dd3fc; /* Brighter blue on hover */
            transform: translateY(-1px);
        }

        /* Secondary Button (Cancel) */
        .btn-secondary { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            color: #94a3b8; 
        }
        .btn-secondary:hover { 
            background: rgba(255, 255, 255, 0.1); 
            color: #f1f5f9;
        }

        /* Special Warning Style (Optional) */
        .modal-box.warning { border-top-color: #f87171; }
        .modal-box.warning .btn-primary { background: #f87171; color: white; }

		/* Container for each checkbox + label pair */
		.status-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
		}
		
		/* Make checkboxes slightly larger and easier to click on Mac */
		.status-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
		}
		
		.status-row label {
            font-size: 0.95rem;
            font-weight: 500;
            margin: 0;
            cursor: pointer;
            flex: 1;
		}

    </style>
</head>
<body>
<div class="fixed-top">
    <div class="btn-row">
        <button class="btn-home" onclick="window.open('index.html', '_blank')" title="CRHP Schedule Hub">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
        </button>
        <button class="btn-ctrl" onclick="exportData()">ðŸ’¾ EXPORT</button>
        <button class="btn-ctrl" onclick="triggerImport()">ðŸ“‚ IMPORT</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)" accept=".json">

        <button class="btn-print" onclick="openPrintService()" title="Print / Save PDF">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
        </button>

        <a href="crhp-viewer.html" class="btn-link" target="_blank" title="Open Viewer">
            <svg viewBox="0 0 24 24"><path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z" /></svg>
        </a>

        <button class="btn-help" onclick="toggleHelp()">?</button>
    </div>
    <div class="section-title">1. Team Roster</div>
    <div class="card">
        <div style="display:flex; gap:5px;"><input type="text" id="rosName" placeholder="Name"><input type="text" id="rosRole" placeholder="Role"></div>
        <button onclick="addRoster()" style="width:100%; padding:12px; background:var(--accent); color:#0f172a; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">+ Add Person</button>
        <div id="rosterDisplay" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
    </div>
	<div class="section-title">2. Room List</div>
	<div class="card">
		<div style="display:flex; gap:5px;"><input type="text" id="roomName" placeholder="Room Name (e.g. Stage A)"></div>
		<button onclick="addRoom()" style="width:100%; padding:12px; background:var(--room); color:#0f172a; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">+ Add Room</button>
		<div id="roomDisplay" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
	</div>
    <div class="day-container">
        <button id="checkToggle" class="checklist-toggle" onclick="activateChecklist()">ðŸ“‹ Checklist</button>
        <div id="dayBar" style="display:flex; gap:8px;"></div>
    </div>
    <div id="creatorTitle" class="section-title">3. Task Creator</div>
    <div class="card">
        <div id="timeInputs" style="display:flex; gap:5px;"><div style="flex:1"><input type="time" id="startTime" value="09:00"></div><div style="flex:1"><input type="time" id="endTime" value="10:00"></div></div>
        <input type="text" id="taskName" placeholder="Task Name">
        <textarea id="taskDesc" placeholder="Description" style="height: auto; min-height:50px; min-width: 910px; max-width: 910px"></textarea>
        <div id="laneToggle" class="toggle-group" style="display:flex; gap:5px; margin-bottom:10px;"><button id="tMain" class="toggle-btn" onclick="setMode('main')">Main</button><button id="tBg" class="toggle-btn" onclick="setMode('bg')">Background</button></div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <div class="section-title" style="font-size: 0.7rem; opacity: 0.8; margin:0;">Assign Rooms</div>
        </div>

        <div id="roomCheckboxes" class="roster-grid" 
            style="margin-bottom:10px; height: auto; min-height: 40px; border:1px solid var(--border); padding:8px; border-radius:6px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
        </div>
        
        <div class="section-title" style="font-size: 0.7rem; opacity: 0.8;">Assign Roster</div>
        <div id="rosterCheckboxes" class="roster-grid" 
            style="margin-bottom:10px; height: auto; min-height: 40px; border:1px solid var(--border); padding:8px; border-radius:6px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
        </div>
        
        <button onclick="addTask()" style="width:100%; padding:14px; background:var(--accent); color:#0f172a; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">ADD TASK</button>
    </div>
</div>

<div class="scroll-wrapper" id="timelineView">
    <div class="timeline-container" id="timelineArea">
        <div id="nowLine"></div>
        <div class="lane-header header-main">MAIN LANE</div>
        <div class="lane-header header-bg">BACKGROUND LANE</div>
        <div class="v-line l-80"></div><div class="v-line l-430"></div>
        <div class="v-line l-510"></div><div class="v-line l-860"></div>
        <div class="time-gutter left-gutter" id="leftGutter"></div>
        <div class="time-gutter center-gutter" id="centerGutter"></div>
        <div id="nodes"></div>
    </div>
</div>

<div class="checklist-container" id="checklistView">
    <div class="section-title">Checklist</div>
    <div id="checklistItems"></div>
</div>

<div id="taskModal" class="modal-overlay" onclick="closeModal(false)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-cancel-x" onclick="closeModal(false)">âœ•</button>
        <h2 id="modalHeader" style="color:var(--accent); font-size: 1.2rem;">Edit</h2>
        <input type="text" id="editTaskName">
        <div id="modalLaneSection">
            <div class="section-title">Switch Lane</div>
            <div class="toggle-group" style="display:flex; gap:5px;"><button id="modalTMain" class="toggle-btn" onclick="setEditMode('main')">Main</button><button id="modalTBg" class="toggle-btn" onclick="setEditMode('bg')">Background</button></div>
        </div>
        <div id="modalTimeSection" style="display:flex; gap:5px; margin-top:10px;"><input type="time" id="editStartTime"><input type="time" id="editEndTime"></div>
        <div class="section-title">Task Description</div>
        <textarea id="modalDescEdit" placeholder="Description" oninput="autoSize(this)" style="min-width: 400px; max-width: 400px; min-height: 100px;"></textarea>
        
        <div class="section-title">Status</div>
        <label class="status-row" for="modalCompleteEdit">
		<input type="checkbox" id="modalCompleteEdit">
        <span>Completed</span>
		</label>
		<label class="status-row" for="modalPendingEdit">
        <input type="checkbox" id="modalPendingEdit">
        <span>Pending</span>
		</label>
		
        <div class="section-title">Assigned Rooms</div>
        <div id="modalRoomGrid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:5px; max-height:150px; overflow-y:auto; padding:5px; background:rgba(0,0,0,0.2); border-radius:6px;">
        </div>
        <div class="section-title">Assigned Crew</div>
        <div id="modalRosterGrid" class="roster-grid"></div>
        <button class="btn-ctrl" style="width:100%; background:var(--accent); color:#0f172a; margin-bottom:10px;" onclick="closeModal(true)">Save Changes</button>
        <button class="btn-ctrl" style="background:var(--danger); color:white; width:100%;" onclick="deleteCurrentTask()">ðŸ—‘ Delete</button>
    </div>
</div>

<div id="rosterEditModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-cancel-x" onclick="closeRosterModal()">Ã—</button>
        <h3 style="color:var(--accent); margin-top:0;">Edit Team Member</h3>
        
        <label style="font-size: 0.8rem; color: #94a3b8;">Name</label>
        <input type="text" id="editRosterName" class="modal-input" style="margin-bottom:15px;">
        
        <label style="font-size: 0.8rem; color: #94a3b8;">Role</label>
        <input type="text" id="editRosterRole" class="modal-input" style="margin-bottom:20px;">
        
        <div style="display: flex; gap: 10px;">
            <button class="btn-ctrl" style="flex:2; border-color:var(--accent); color:var(--accent);" onclick="saveRosterEdit()">Save Changes</button>
            <button class="btn-ctrl" style="flex:1; border-color:var(--danger); color:var(--danger);" onclick="triggerRosterDelete()">Delete</button>
        </div>
    </div>
</div>

<div id="roomEditModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-cancel-x" onclick="closeRoomModal()">âœ•</button>
        <h3 style="color:var(--room); margin-top:0;">Edit Room</h3>
        
        <label style="font-size: 0.75rem; opacity: 0.7;">Room Name</label>
        <input type="text" id="editRoomNameInput" class="modal-input" style="width:100%; margin-bottom:20px; background: #0f172a; color: white; border: 1px solid #334155; padding: 10px; border-radius: 6px;">
        
        <div style="display: flex; gap: 10px;">
            <button class="btn-ctrl" style="flex:2; border-color:var(--accent); color:var(--accent);" onclick="saveRoomEdit()">Save Changes</button>
            <button class="btn-ctrl" style="flex:1; border-color:var(--danger); color:var(--danger);" onclick="triggerRoomDelete()">Delete</button>
        </div>
    </div>
</div>

<div id="helpModal" class="modal-overlay" style="
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.7); 
    z-index: 10000; 
    align-items: center; 
    justify-content: center;
">
    <div class="modal-content" style="
        background: #1e293b; 
        color: white; 
        padding: 25px; 
        border-radius: 12px; 
        width: 90%; 
        max-width: 450px; 
        position: relative;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    ">
        <button class="modal-cancel-x" onclick="toggleHelp()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer;">Ã—</button>
        
        <h3 style="color:var(--accent); margin-top:0; border-bottom:1px solid #334155; padding-bottom:10px;">User Guide</h3>
        
        <div class="help-content" style="line-height: 1.5;">
            <b>Main Lane:</b> Primary schedule tasks (Blue).<br>
            <b>Background Lane:</b> Secondary/support tasks (Purple).<br>
            <hr style="border:0; border-top:1px solid #334155; margin:10px 0;">
            <ul style="padding-left: 20px; margin: 0 0 15px 0;">
                <li><b>Add Task:</b> Click the '+' in the task creator.</li>
                <li><b>Edit:</b> Tap any task to change crew or details.</li>
                <li><b>Now Line:</b> The dashed red line shows the current time.</li>
                <li><b>Checklist:</b> Toggle mode to view tasks as a simple list.</li>
            </ul>
            
            <div style="background: rgba(239, 68, 68, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                <p style="color:var(--danger); font-size:0.75rem; margin: 0 0 10px 0; font-weight:bold; text-transform:uppercase; letter-spacing: 0.05em;">Admin Tools</p>
                
                <button class="btn-ctrl" style="border-color:var(--danger); color:var(--danger); width:100%; margin-bottom:10px; background: transparent;" onclick="resetToMaster()">
                    Reset to CRHP Master Template
                </button>

                <button class="btn-ctrl" style="background:rgba(239, 68, 68, 0.1); border-color:var(--danger); color:var(--danger); width:100%;" onclick="clearScheduleFresh()">
                    ðŸ—‘ Clear All (Fresh Start)
                </button>
            </div>

            <p style="font-size:0.75rem; opacity:0.7; font-style:italic; margin-top: 15px;">Note: Use Export to save your data before clearing the cache.</p>
        </div>
        
        <button class="btn-ctrl" style="width:100%; margin-top:20px; padding: 10px; font-weight: bold;" onclick="toggleHelp()">Close</button>
    </div>
</div>

<script>
    let tasks = JSON.parse(localStorage.getItem('v50_tasks')) || [];
    let checklist = JSON.parse(localStorage.getItem('v50_checklist')) || [];
    let roster = JSON.parse(localStorage.getItem('v50_roster')) || [];
    let totalDays = parseInt(localStorage.getItem('v50_days')) || 1;
    let currentDay = 1, mode = 'main', editMode = 'main', activeTaskIndex = null, isChecklistMode = false, cachedDStart = 0;
	let rooms = JSON.parse(localStorage.getItem('v50_rooms')) || [];

    const saveAll = () => { 
        localStorage.setItem('v50_tasks', JSON.stringify(tasks)); 
        localStorage.setItem('v50_checklist', JSON.stringify(checklist));
        localStorage.setItem('v50_roster', JSON.stringify(roster)); 
        localStorage.setItem('v50_days', totalDays);
		localStorage.setItem('v50_rooms', JSON.stringify(rooms));
    };
	
    const MASTER_TEMPLATE = `{"tasks":[{"day":1,"start":"09:00","end":"09:30","name":"Reconciliation Witness","desc":"Jacob gives reconciliation witness.","people":["Jacob (Facilities leader)"],"type":"main","complete":false,"pending":false},{"day":1,"start":"08:30","end":"09:00","name":"Breakfast","desc":"Breakfast and fellowship","people":[],"type":"main","pending":false,"complete":false,"room":""},{"day":1,"start":"08:45","end":"09:00","name":"Pray with witness","desc":"Thomas pray with Jacob in chapel","people":["Jacob (Facilities leader)","Thomas (Formation leader)"],"type":"bg","pending":false,"complete":false,"room":"Chapel"},{"day":1,"start":"08:30","end":"09:30","name":"Sacristan duties","desc":"Jonathan has to pick up priest","people":["Jonathan (Sacristan)"],"type":"bg","complete":false,"pending":false,"room":"Chapel"},{"day":1,"start":"10:00","end":"10:05","name":"Break","desc":"Get up, bathroom, snacks, water","people":["Jacob (Facilities leader)","Jonathan (Sacristan)","Thomas (Formation leader)"],"type":"main","pending":false,"complete":false,"room":"Any"},{"day":1,"start":"22:00","end":"23:59","name":"Now line tester","desc":"","people":[],"type":"main","room":"","pending":false,"complete":false}],"checklist":[{"name":"Test bro","desc":"Yo ","people":["Jacob (Facilities leader)"],"done":false,"pending":false}],"roster":[{"name":"Jacob","role":"Facilities leader"},{"name":"Jonathan","role":"Sacristan"},{"name":"Thomas","role":"Formation leader"}],"rooms":["Chapel","Any"],"totalDays":1}`;

    // 1. Initial attempt to load from storage
    let rawTasks = localStorage.getItem('v50_tasks');
    let rawRoster = localStorage.getItem('v50_roster');
    let rawRooms = localStorage.getItem('v50_rooms');

    // 2. The Logic: If there's no roster OR no tasks, load the Master Template
    if (!rawRoster || !rawTasks || !rawRooms) {
        console.log("No saved data found. Loading Master Template...");
        const data = JSON.parse(MASTER_TEMPLATE);
        
        tasks = data.tasks;
        checklist = data.checklist;
        roster = data.roster;
        rooms = data.rooms;
        totalDays = data.totalDays || 1;
        
        // Save immediately so the next refresh sees the data
        saveAll();
    } else {
        // 3. Data exists! Parse it into our active variables
        tasks = JSON.parse(rawTasks);
        checklist = JSON.parse(localStorage.getItem('v50_checklist')) || [];
        roster = JSON.parse(rawRoster);
        rooms = JSON.parse(rawRooms);
        totalDays = parseInt(localStorage.getItem('v50_days')) || 1;
    }

    function activateChecklist() { isChecklistMode = true; updateViewToggles(); renderDays(); renderChecklist(); }
    function activateDay(day) { isChecklistMode = false; currentDay = day; updateViewToggles(); renderDays(); renderTasks(); }

    function updateNowLine() {
        if(isChecklistMode) return;
        const line = document.getElementById('nowLine');
        const now = new Date();
        const nowMins = (now.getHours() * 60) + now.getMinutes();
        const pos = (nowMins - cachedDStart) * 3 + 35;
        
        document.querySelectorAll('.now-time-indicator').forEach(el => el.remove());

        if (pos > 35 && pos < document.getElementById('timelineArea').offsetHeight) {
            line.style.top = pos + 'px'; 
            line.style.display = 'block';
            
            const timeStr = formatTo12h(`${now.getHours()}:${now.getMinutes()}`);
            const indicatorHtml = `<div class="now-time-indicator" style="top:${pos}px">${timeStr}</div>`;
            document.getElementById('leftGutter').insertAdjacentHTML('beforeend', indicatorHtml);
            document.getElementById('centerGutter').insertAdjacentHTML('beforeend', indicatorHtml);
        } else { 
            line.style.display = 'none'; 
        }
    }

    function toggleStatus(index, type, event) {
        event.stopPropagation();
        const t = tasks[index];
        if (type === 'P') { t.pending = !t.pending; if(t.pending) t.complete = false; }
        if (type === 'C') { t.complete = !t.complete; if(t.complete) t.pending = false; }
        saveAll(); renderTasks();
    }

    function toggleCheckStatus(index, type, event) {
        event.stopPropagation();
        const item = checklist[index];
        if (type === 'P') { item.pending = !item.pending; if(item.pending) item.done = false; }
        if (type === 'C') { item.done = !item.done; if(item.done) item.pending = false; }
        saveAll(); renderChecklist();
    }

    function updateViewToggles() {
        const timeline = document.getElementById('timelineView'), checkView = document.getElementById('checklistView');
        const timeInputs = document.getElementById('timeInputs'), laneToggle = document.getElementById('laneToggle');
        const creatorTitle = document.getElementById('creatorTitle'), btn = document.getElementById('checkToggle');
        if(isChecklistMode) {
            timeline.style.display = 'none'; checkView.style.display = 'block'; timeInputs.style.display = 'none';
            laneToggle.style.display = 'none'; creatorTitle.innerHTML = '2. Task Creator (Global Checklist)'; btn.classList.add('active');
        } else {
            timeline.style.display = 'block'; checkView.style.display = 'none'; timeInputs.style.display = 'flex';
            laneToggle.style.display = 'flex'; creatorTitle.innerHTML = `2. Task Creator (Day ${currentDay})`; btn.classList.remove('active');
        }
    }

    function renderChecklist() {
        const container = document.getElementById('checklistItems');
        container.innerHTML = checklist.map((item, i) => {
            const crewFormatted = item.people.map(p => {
                const parts = p.split(' (');
                return `${parts[0]} <small>(${parts[1]}</small>`;
            }).join(', ');
            return `
            <div class="check-item ${item.pending ? 'is-pending' : ''} ${item.done ? 'is-complete' : ''}" onclick="openModal(${i}, true)">
                <span class="check-del" onclick="event.stopPropagation(); deleteCheckItem(${i})">âœ•</span>
                <div class="check-status-row">
                    <div class="tiny-toggle ${item.pending ? 'active' : ''}" onclick="toggleCheckStatus(${i}, 'P', event)">P</div>
                    <div class="tiny-toggle ${item.done ? 'active' : ''}" onclick="toggleCheckStatus(${i}, 'C', event)">C</div>
                </div>
                <span class="check-item-title">${item.name}</span>
                <div class="check-item-desc" style="font-size:0.9rem; margin-bottom:8px; opacity:0.8;">${item.desc}</div>
                <div class="crew-list">${item.people.length > 0 ? '<span class="assigned-label">Assigned:</span> ' + crewFormatted : ''}</div>
            </div>`;
        }).join('');
    }

    function openModal(index, fromChecklist = false) {
        activeTaskIndex = index; 
        document.body.classList.add('modal-open');
        const t = fromChecklist ? checklist[index] : tasks[index];
        
        document.getElementById('modalHeader').innerText = fromChecklist ? "Edit Checklist Item" : "Edit Task";
        document.getElementById('editTaskName').value = t.name;
        document.getElementById('modalDescEdit').value = t.desc || "";
        document.getElementById('modalPendingEdit').checked = t.pending || false;
        document.getElementById('modalCompleteEdit').checked = (fromChecklist ? t.done : t.complete) || false;
        
        if(fromChecklist) {
            document.getElementById('modalLaneSection').style.display = 'none';
            document.getElementById('modalTimeSection').style.display = 'none';
        } else {
            document.getElementById('modalLaneSection').style.display = 'block';
            document.getElementById('modalTimeSection').style.display = 'flex';
            document.getElementById('editStartTime').value = t.start;
            document.getElementById('editEndTime').value = t.end;
            
            // --- CHANGED: Use renderEditRooms instead of setting value ---
            // Checks for t.rooms array first, falls back to legacy t.room string
            renderEditRooms(t.rooms || t.room); 

            setEditMode(t.type || 'main');
        }
        
        renderEditRoster(t.people || []); 
        
        // Setup Exclusivity Logic
        const pendingBox = document.getElementById('modalPendingEdit');
        const completeBox = document.getElementById('modalCompleteEdit');

        pendingBox.onchange = () => {
            if (pendingBox.checked) completeBox.checked = false;
        };

        completeBox.onchange = () => {
            if (completeBox.checked) pendingBox.checked = false;
        };

        document.getElementById('taskModal').style.display = 'block';
    }

    function closeModal(save) {
        if(save) {
            const isEditingChecklist = document.getElementById('modalHeader').innerText.includes("Checklist");
            const t = isEditingChecklist ? checklist[activeTaskIndex] : tasks[activeTaskIndex];
            
            const name = document.getElementById('editTaskName').value;
            const desc = document.getElementById('modalDescEdit').value;
            const crew = Array.from(document.querySelectorAll('#modalRosterGrid input:checked')).map(c => c.value);
            
            // Capture Status
            const pending = document.getElementById('modalPendingEdit').checked;
            const complete = document.getElementById('modalCompleteEdit').checked;

            // --- CHANGED: Capture Rooms as Array ---
            const roomArray = Array.from(document.querySelectorAll('#modalRoomGrid input:checked')).map(c => c.value);
            const roomString = roomArray.join(', '); // For legacy support/display
            // --------------------------------------

            if(isEditingChecklist) {
                t.name = name; 
                t.desc = desc; 
                t.people = crew; 
                t.pending = pending; 
                t.done = complete;
            } else {
                let s = document.getElementById('editStartTime').value;
                let e = document.getElementById('editEndTime').value;
                if (e === "00:00") { e = "23:59"; }
                
                if(getMins(e) < getMins(s)) {
                    // Midnight Span Logic
                    const originalDay = t.day;
                    tasks.splice(activeTaskIndex, 1);
                    
                    // Part 1
                    tasks.push({ 
                        day: originalDay, start: s, end: "23:59", 
                        name, desc, people: crew, type: editMode, 
                        rooms: roomArray, room: roomString, // Save both
                        pending, complete 
                    });
                    
                    if (originalDay === totalDays) { totalDays++; renderDays(); }

                    // Part 2
                    tasks.push({ 
                        day: originalDay + 1, start: "00:00", end: e, 
                        name, desc, people: crew, type: editMode, 
                        rooms: roomArray, room: roomString, // Save both
                        pending, complete 
                    });
                } else {
                    // Normal Update
                    t.name = name; 
                    t.desc = desc; 
                    t.people = crew; 
                    t.pending = pending; 
                    t.complete = complete;
                    t.start = s; 
                    t.end = e; 
                    t.type = editMode; 
                    
                    // Save Rooms
                    t.rooms = roomArray;
                    t.room = roomString; 
                }
            }
            saveAll(); 
            isChecklistMode ? renderChecklist() : renderTasks();
        }

        // Cleanup
        document.body.classList.remove('modal-open'); 
        document.getElementById('taskModal').style.display = 'none';
        
        // Clear selections
        document.querySelectorAll('#modalRosterGrid input').forEach(cb => cb.checked = false);
        document.querySelectorAll('#modalRoomGrid input').forEach(cb => cb.checked = false);
    }

    function addTask() {
        const n = document.getElementById('taskName').value, d = document.getElementById('taskDesc').value;
        const p = Array.from(document.querySelectorAll('#rosterCheckboxes input:checked')).map(c => c.value);
        
        // --- CHANGED: Capture Multiple Rooms from the new checkbox grid ---
        const selectedRooms = Array.from(document.querySelectorAll('#roomCheckboxes input:checked')).map(c => c.value);
        const roomStr = selectedRooms.join(', '); // Legacy string support
        // ------------------------------------------------------------------

        if(!n) return;
        if(isChecklistMode) {
            checklist.push({ name: n, desc: d, people: p, done: false, pending: false });
        } else {
            let s = document.getElementById('startTime').value, e = document.getElementById('endTime').value;
            if (e === "00:00") { e = "23:59"; }
            
            if(getMins(e) < getMins(s)) {
                // Task crosses midnight - Day 1
                tasks.push({ 
                    day: currentDay, start: s, end: "23:59", name: n, desc: d, people: p, type: mode, 
                    rooms: selectedRooms, // Array
                    room: roomStr,        // String
                    pending: false, complete: false 
                });
                if (currentDay === totalDays) { totalDays++; renderDays(); }
                // Task crosses midnight - Day 2
                tasks.push({ 
                    day: currentDay + 1, start: "00:00", end: e, name: n, desc: d, people: p, type: mode, 
                    rooms: selectedRooms, // Array
                    room: roomStr,        // String
                    pending: false, complete: false 
                });
            } else {
                // Standard single day
                tasks.push({ 
                    day: currentDay, start: s, end: e, name: n, desc: d, people: p, type: mode, 
                    rooms: selectedRooms, // Array
                    room: roomStr,        // String
                    pending: false, complete: false 
                });
            }
        }
        
        saveAll(); 
        isChecklistMode ? renderChecklist() : renderTasks();
        
        // --- RESET FORM ---
        document.getElementById('taskName').value = ''; 
        document.getElementById('taskDesc').value = '';
        
        // Clear both Roster and Room checkboxes
        document.querySelectorAll('#rosterCheckboxes input, #roomCheckboxes input').forEach(cb => cb.checked = false);
    }

    const formatTo12h = (t) => { 
        if(!t) return ""; 
        let [h, m] = t.split(':').map(Number); 
        return `${h % 12 || 12}:${m.toString().padStart(2,'0')} ${h >= 12 ? 'PM' : 'AM'}`; 
    };
    const getMins = (t) => { let [h, m] = t.split(':').map(Number); return (h * 60) + m; };

    function renderTasks() {
        if(isChecklistMode) return;
        const nodes = document.getElementById('nodes'), area = document.getElementById('timelineArea');
        nodes.innerHTML = ''; document.getElementById('leftGutter').innerHTML = ''; document.getElementById('centerGutter').innerHTML = '';
        const dayTasks = tasks.filter(t => t.day === currentDay).sort((a,b) => getMins(a.start) - getMins(b.start));
        if(!dayTasks.length) { area.style.height = '400px'; cachedDStart = 540; updateNowLine(); return; }
        
        const dStart = Math.floor(Math.min(...dayTasks.map(t => getMins(t.start))) / 15) * 15;
        const dEnd = Math.ceil(Math.max(...dayTasks.map(t => Math.max(getMins(t.start) + 5, getMins(t.end)))) / 15) * 15;
        cachedDStart = dStart;

        for(let m=dStart; m<=dEnd; m+=15){
            const pos = (m-dStart)*3 + 35, mins=m%60;
            const hourStr = Math.floor(m/60)+':'+mins.toString().padStart(2,'0');
            const lbl = `<div class="hour-mark" style="top:${pos}px">${formatTo12h(hourStr)}</div>`;
            document.getElementById('leftGutter').innerHTML += lbl; document.getElementById('centerGutter').innerHTML += lbl;
            nodes.innerHTML += `<div class="hour-line ${mins===0?'major':''}" style="top:${pos}px"></div>`;
        }

        ['main', 'bg'].forEach(lt => {
            const ltTasks = dayTasks.filter(t => t.type === lt);
            const columns = [];

            ltTasks.forEach(t => {
                const s1 = getMins(t.start);
                const e1 = Math.max(s1 + 5, getMins(t.end));
                const overlapping = ltTasks.filter(ot => {
                    const os = getMins(ot.start);
                    const oe = Math.max(os + 5, getMins(ot.end));
                    return (s1 < oe && os < e1);
                });
                let maxSimultaneous = 0;
                for (let time = s1; time < e1; time++) {
                    const count = overlapping.filter(ot => {
                        const os = getMins(ot.start);
                        const oe = Math.max(os + 5, getMins(ot.end));
                        return time >= os && time < oe;
                    }).length;
                    maxSimultaneous = Math.max(maxSimultaneous, count);
                }
                let colIndex = 0;
                while (columns[colIndex] > s1) { colIndex++; }
                columns[colIndex] = e1;

                const node = document.createElement('div');
                node.className = `task-node ${lt === 'main'?'main-node':'bg-node'} ${t.pending ? 'is-pending' : ''} ${t.complete ? 'is-complete' : ''}`;
                const nodeHeight = Math.max(15, (getMins(t.end) - s1) * 3);
                const laneWidth = 340 / maxSimultaneous;
                node.style.cssText = `top:${(s1-dStart)*3+35}px; height:${nodeHeight}px; width:${laneWidth-1}px; left:${(lt==='main'?65:495)+(colIndex*laneWidth)}px;`;
                node.onclick = () => openModal(tasks.indexOf(t), false);
                
                const timeRangeStr = `${formatTo12h(t.start)} - ${formatTo12h(t.end)}`;
                const crewCount = t.people ? t.people.length : 0;
                
                // 1. Clean Names Logic
                const slimNames = t.people ? t.people.map(p => p.split(' (')[0]).join(', ') : '';
                const fullCrew = t.people ? t.people.map(p => {
                    const parts = p.split(' (');
                    const namePart = parts[0].trim();
                    const rolePart = parts[1] ? parts[1].replace(')', '').trim() : null;
                    return rolePart ? `${namePart} <small>(${rolePart})</small>` : namePart;
                }).join(', ') : '';

                // 2. Room Logic
                const roomLabel = (t.rooms && t.rooms.length > 0) ? t.rooms.join(', ') : (t.room || "");
                const roomBlock = roomLabel ? `<div class="room-label" style="margin-bottom:0px; color:var(--room); font-weight:bold;">${roomLabel}</div>` : "";

                const showButtons = maxSimultaneous < 3;
                const statusHtml = showButtons ? `
                    <div class="status-toggles">
                        <div class="tiny-toggle ${t.pending ? 'active' : ''}" onclick="toggleStatus(${tasks.indexOf(t)}, 'P', event)">P</div>
                        <div class="tiny-toggle ${t.complete ? 'active' : ''}" onclick="toggleStatus(${tasks.indexOf(t)}, 'C', event)">C</div>
                    </div>` : '';

                if (nodeHeight < 40) {
                    node.innerHTML = `
                        <div class="ultra-compact-text" style="
                            font-size: 8px; 
                            font-weight: bold; 
                            height: 100%; 
                            display: flex; 
                            align-items: center; 
                            white-space: nowrap; 
                            /* Change to visible so text can "bleed" slightly if needed rather than cut */
                            overflow: visible; 
                            gap: 3px;
                            padding: 0 2px;
                            /* This ensures the flexbox ignores the parent's padding constraints */
                            width: 100%;
                            position: absolute;
                            top: 50%;
                            transform: translateY(-50%);
                            margin: 0;
                        ">
                            <span style="flex-shrink: 1; overflow: hidden; text-overflow: ellipsis; padding: 2px 0;">${t.name}</span>
                            <span style="opacity: 0.7; flex-shrink: 0;">(${timeRangeStr})</span>
                            
                            ${roomLabel ? `
                                <span class="uc-room" style="
                                    color: var(--room); 
                                    flex-shrink: 1; 
                                    overflow: hidden;
                                    text-overflow: ellipsis; 
                                    padding: 2px 0;
                                ">[${roomLabel}]</span>
                            ` : ''}
                            
                            ${crewCount > 0 ? `
                                <span class="uc-count" style="flex-shrink: 0; opacity: 0.8;">[${crewCount}p]</span>
                            ` : ''}
                        </div>`;
                } else if (nodeHeight < 60) {
                    node.innerHTML = `
                        <div class="status-header-row" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 4px; width: 100%; overflow: hidden;">
                            <div class="task-title" style="
                                white-space: nowrap; 
                                overflow: hidden; 
                                text-overflow: ellipsis; 
                                flex-grow: 1; 
                                min-width: 0; 
                                font-weight: bold;
                            ">${t.name}</div>
                            ${statusHtml}
                        </div>
                        <div class="task-meta" style="font-size: 0.75rem; width: 100%; overflow: hidden;">
                            <div class="crew-list" style="
                                white-space: nowrap; 
                                overflow: hidden; 
                                text-overflow: ellipsis; 
                                width: 100%;
                            ">
                                <span style="opacity:0.8; flex-shrink: 0;">${timeRangeStr}</span>
                                ${roomLabel ? ` | <span class="room-label" style="color:var(--room); font-weight:bold;">${roomLabel}</span>` : ''}
                                ${slimNames ? ` | <span style="opacity:0.6">${slimNames}</span>` : ''}
                            </div>
                        </div>`;
                } else {
                    // LARGE VIEW - Protection & Dynamic Row Merging
                    const hasCrew = crewCount > 0;
                    const isMediumLarge = nodeHeight < 85; // The "In-Between" zone
                    
                    // Determine Crew HTML
                    const crewHtml = hasCrew 
                        ? (isMediumLarge ? slimNames : `<span class="assigned-label">Assigned:</span> ${fullCrew}`)
                        : "";
                    
                    // NEW: Logic to merge Room and Crew if space is tight
                    let metaContentHtml = '';
                    if (isMediumLarge && t.room && hasCrew) {
                        // Combined line: Room | Names
                        metaContentHtml = `
                            <div style="color: var(--room); font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; font-size: 0.85em;">
                                ${t.room} <span style="color: var(--text); opacity: 0.4; font-weight: normal; margin: 0 4px;">|</span> 
                                <span style="color: var(--text); opacity: 0.7; font-weight: normal;">${slimNames}</span>
                            </div>`;
                    } else {
                        // Standard Stacked Layout
                        metaContentHtml = `
                            ${t.room ? `<div class="room-label" style="color: var(--room); font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;">${t.room}</div>` : ""} 
                            <div class="crew-list" style="${hasCrew ? 'border-top: 1px solid rgba(0,0,0,0.08); margin-top: 4px; padding-top: 4px;' : ''} overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; white-space: normal; font-size: 0.85em;">
                                ${crewHtml}
                            </div>`;
                    }

                    node.innerHTML = `
                        <div class="status-header-row" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 4px; width: 100%; overflow: hidden;">
                            <div class="task-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; min-width: 0; font-weight: bold;">${t.name}</div>
                            ${statusHtml}
                        </div>
                        <div class="task-meta" style="width: 100%; overflow: hidden; display: flex; flex-direction: column;">
                            <div class="time-range" style="font-size: 0.85em; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;">${timeRangeStr}</div>
                            ${metaContentHtml}
                        </div>`;
                }
                nodes.appendChild(node);
            });
        });
        area.style.height = (dEnd-dStart)*3 + 250 + 'px'; updateNowLine();
    }

    function removePersonFromTasks(personKey) {
        tasks.forEach(t => { if(t.people) t.people = t.people.filter(p => p !== personKey); });
        checklist.forEach(i => { if(i.people) i.people = i.people.filter(p => p !== personKey); });
    }

	function addRoster() { 
        const n = document.getElementById('rosName').value, r = document.getElementById('rosRole').value; 
        if(n){ roster.push({name:n, role:r || ""}); saveAll(); renderRoster(); document.getElementById('rosName').value=''; document.getElementById('rosRole').value=''; }
    }

    let editingRosterIndex = null;

    function openRosterEdit(i) {
        editingRosterIndex = i;
        const p = roster[i];
        document.getElementById('editRosterName').value = p.name;
        document.getElementById('editRosterRole').value = p.role;
        document.getElementById('rosterEditModal').style.display = 'block';
    }

    function closeRosterModal() {
        document.getElementById('rosterEditModal').style.display = 'none';
        editingRosterIndex = null;
    }

    function saveRosterEdit() {
        const i = editingRosterIndex;
        const p = roster[i];
        
        // This matches the format "Name (Role)"
        const oldKey = `${p.name} (${p.role})`; 
        
        const newName = document.getElementById('editRosterName').value.trim();
        const newRole = document.getElementById('editRosterRole').value.trim();
        const newKey = `${newName} (${newRole})`;

        if (!newName) return;

        // 1. Update the tasks array - TARGETING 'people' specifically
        tasks.forEach(t => {
            // We check 'people' because that's what your renderTasks function uses
            if (t.people && Array.isArray(t.people)) {
                t.people = t.people.map(personString => {
                    // If the string matches the old Name (Role), replace it
                    return personString === oldKey ? newKey : personString;
                });
            }
        });

        // 2. Update the roster array so the sidebar/list is current
        roster[i] = { name: newName, role: newRole };

        if (document.getElementById('taskModal').style.display === 'block') {
            // 1. Find all checkboxes that are currently checked in the task modal
            const currentlyChecked = Array.from(document.querySelectorAll('#modalRosterGrid input:checked'))
                .map(cb => cb.value);
            
            // 2. If the person we just edited was checked, update their name in our temporary list
            const updatedChecked = currentlyChecked.map(val => val === oldKey ? newKey : val);
            
            // 3. Redraw the checklist so it shows the new name and keeps the checkmarks
            renderEditRoster(updatedChecked);
        }

        // 3. Save and Refresh
        saveAll();
        renderRoster(); // Updates your sidebar list
        renderTasks();  // This will now find the updated names in t.people and redraw the blocks
        
        closeRosterModal();
    }

    function triggerRosterDelete() {
        const i = editingRosterIndex;
        const personName = roster[i].name;

        showModal(
            "Delete Team Member?", 
            `Are you sure you want to delete ${personName}? This will also remove them from all assigned tasks.`,
            () => {
                const key = `${roster[i].name} (${roster[i].role})`;
                removePersonFromTasks(key);
                roster.splice(i, 1);
                saveAll();
                renderRoster();
                renderTasks();
                closeRosterModal();
            },
            true,
            "Delete Member",
            "danger",
            "Cancel"
        );
    }

    window.addEventListener('click', (e) => {
        const rosterModal = document.getElementById('rosterEditModal');
        const taskModal = document.getElementById('taskModal');
        const helpModal = document.getElementById('helpModal');

        // If the click target is the overlay itself (not the content box inside)
        if (e.target === rosterModal) {
            closeRosterModal();
        }
        if (e.target === taskModal) {
            closeModal(false); // Close without saving
        }
        if (e.target === helpModal) {
            toggleHelp();
        }
        if (e.target === document.getElementById('roomEditModal')) {
            closeRoomModal();
    }
    });

    function renderRoster() {
        // 1. Main Display List (The pills at the top)
        document.getElementById('rosterDisplay').innerHTML = roster.map((p, i) => 
            `<div onclick="openRosterEdit(${i})" style="background:#334155; padding:4px 8px; border-radius:6px; font-size:11px; cursor:pointer; display:inline-block; margin:2px;">
                ${p.name} <small>(${p.role})</small> 
            </div>`
        ).join('');
        
        // 2. Task Creator Grid (Updated for 3-column expanding layout)
        const creatorRosterGrid = document.getElementById('rosterCheckboxes');
        if (creatorRosterGrid) {
            creatorRosterGrid.innerHTML = roster.map((p, i) => {
                const fullName = `${p.name} (${p.role})`;
                return `
                    <div class="roster-item" style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: rgba(56, 189, 248, 0.05); margin-bottom: 2px; border-radius: 4px; border: 1px solid rgba(56, 189, 248, 0.1);">
                        <div style="display: flex; align-items: center; flex: 1; cursor: pointer; overflow: hidden;" onclick="const ck=this.querySelector('input'); ck.checked=!ck.checked;">
                            <input type="checkbox" value="${fullName}" onclick="event.stopPropagation()" style="accent-color:var(--accent);">
                            <span style="margin-left: 8px; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${p.name} <small style="color:var(--accent); font-weight:bold; font-size: 9px;">(${p.role})</small>
                            </span>
                        </div>
                        <span onclick="event.stopPropagation(); openRosterEdit(${i})" style="cursor: pointer; padding: 0 2px; opacity: 0.6; font-size: 12px;">âš™ï¸</span>
                    </div>
                `;
            }).join('');
        }
    }

    function renderEditRooms(assignedRooms) {
        const container = document.getElementById('modalRoomGrid');
        if (!container) return;

        let currentRooms = Array.isArray(assignedRooms) ? assignedRooms : (assignedRooms ? [assignedRooms] : []);

        container.innerHTML = rooms.map((r, i) => {
            const isChecked = currentRooms.includes(r) ? 'checked' : '';
            return `
                <div class="roster-item" style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: rgba(255,255,255,0.05); margin-bottom: 2px; border-radius: 4px;">
                    <div style="display: flex; align-items: center; flex: 1; cursor: pointer;" onclick="const ck=this.querySelector('input'); ck.checked=!ck.checked;">
                        <input type="checkbox" value="${r}" ${isChecked} onclick="event.stopPropagation()" style="accent-color:var(--room);">
                        <span style="margin-left: 8px; font-size: 0.9rem; color:var(--room);">${r}</span>
                    </div>
                    <span onclick="event.stopPropagation(); openRoomEdit(${i})" style="cursor: pointer; padding: 0 5px; opacity: 0.6; font-size: 14px;">âš™ï¸</span>
                </div>
            `;
        }).join('');
    }

	function addRoom() {
	    // 1. Get the input
        const input = document.getElementById('roomName');
        const n = input.value.trim();
	
        if (n) {
	        // 2. Update the array
            rooms.push(n);
	
	        // 3. Use your existing saveAll function
            saveAll(); 
	
	        // 4. Refresh the UI
            renderRooms(); 
	
	        // 5. Clear the input
            input.value = '';
        }
	}

    function openQuickRoomEdit() {
        const currentRoom = document.getElementById('editTaskRoom').value;
        if (!currentRoom) {
            showModal(
                "No Room Selected", 
                "Please select a room from the dropdown first to edit it, or use the Room List at the top to manage all rooms.",
                null,    // No function to run
                false,   // No cancel button needed
                "OK"     // Custom button text
            );
            return;
        }
        const roomIndex = rooms.indexOf(currentRoom);
        if (roomIndex !== -1) openRoomEdit(roomIndex);
    }

    function renderRooms() {
        // 1. Management List at the bottom
        const display = document.getElementById('roomDisplay');
        if (display) {
            display.innerHTML = rooms.map((r, i) => 
                `<div onclick="openRoomEdit(${i})" style="background:#334155; padding:4px 8px; border-radius:6px; font-size:11px; border:1px solid var(--room); cursor:pointer;">
                    ${r}
                </div>`
            ).join('');
        }

        // 2. Task Creator Grid (Matching the Roster style)
        const creatorGrid = document.getElementById('roomCheckboxes');
        if (creatorGrid) {
            creatorGrid.innerHTML = rooms.map((r, i) => `
                <div class="roster-item" style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: rgba(252, 211, 77, 0.05); margin-bottom: 2px; border-radius: 4px; border: 1px solid rgba(252, 211, 77, 0.1);">
                    <div style="display: flex; align-items: center; flex: 1; cursor: pointer;" onclick="const ck=this.querySelector('input'); ck.checked=!ck.checked;">
                        <input type="checkbox" value="${r}" onclick="event.stopPropagation()" style="accent-color:var(--room);">
                        <span style="margin-left: 8px; font-size: 11px; color:var(--room);">${r}</span>
                    </div>
                    <span onclick="event.stopPropagation(); openRoomEdit(${i})" style="cursor: pointer; padding: 0 5px; opacity: 0.6; font-size: 12px;">âš™ï¸</span>
                </div>
            `).join('');
        }

        // 3. Sync Modal if open
        if (document.getElementById('taskModal').style.display === 'block') {
            const t = isChecklistMode ? checklist[activeTaskIndex] : tasks[activeTaskIndex];
            renderEditRooms(t ? (t.rooms || t.room) : []);
        }
    }

    let editingRoomIndex = null;

    function openRoomEdit(i) {
        editingRoomIndex = i;
        const roomName = rooms[i];
        
        // Ensure the input exists before setting value
        const input = document.getElementById('editRoomNameInput');
        if (input) {
            input.value = roomName;
        }
        
        document.getElementById('roomEditModal').style.display = 'block';
    }

    function closeRoomModal() {
        document.getElementById('roomEditModal').style.display = 'none';
        editingRoomIndex = null;
    }

    function saveRoomEdit() {
        const oldName = rooms[editingRoomIndex];
        // Fixed ID here to match your HTML: editRoomNameInput
        const input = document.getElementById('editRoomNameInput');
        const newName = input ? input.value.trim() : "";

        if (!newName || newName === oldName) {
            closeRoomModal();
            return;
        }

        tasks.forEach(t => {
            if (t.room === oldName) t.room = newName;
        });

        rooms[editingRoomIndex] = newName;

        saveAll();
        renderRooms();
        renderTasks();
        
        // Sync the task modal dropdown if it's currently open
        const editSelect = document.getElementById('editTaskRoom');
        if (document.getElementById('taskModal').style.display === 'block' && editSelect.value === oldName) {
            editSelect.value = newName;
        }

        closeRoomModal();
    }

    function triggerRoomDelete() {
        // 1. Safety check for the index
        if (editingRoomIndex === null) return;
        
        const nameToRemove = rooms[editingRoomIndex];

        showModal(
            "Delete Room?", 
            `Are you sure you want to delete "${nameToRemove}"? Any tasks currently in this room will be set to "No Room Assigned".`,
            () => {
                // 2. Clear room from tasks
                tasks.forEach(t => {
                    if (t.room === nameToRemove) t.room = "";
                });
                
                // 3. Remove from array and sync
                rooms.splice(editingRoomIndex, 1);
                saveAll();
                renderRooms();
                renderTasks();
                closeRoomModal();
            },
            true,
            "Delete Room",
            "danger",
            "Cancel"
        );
    }

    function renderDays() {
        const bar = document.getElementById('dayBar'); bar.innerHTML = '';
        for(let i=1; i<=totalDays; i++){
            const d = document.createElement('div'); d.className = `day-btn ${i===currentDay && !isChecklistMode ?'active':''}`;
            d.onclick = () => activateDay(i); d.innerHTML = `Day ${i} <span class="day-delete-x" onclick="deleteDay(event,${i})">âœ•</span>`;
            bar.appendChild(d);
        }
        const add = document.createElement('button'); add.className='day-add'; add.innerText='+ Day'; add.onclick=()=>{ totalDays++; activateDay(totalDays); };
        bar.appendChild(add);
    }
    
    function setMode(m) { mode = m; document.getElementById('tMain').className = `toggle-btn ${m==='main'?'active-main':''}`; document.getElementById('tBg').className = `toggle-btn ${m==='bg'?'active-bg':''}`; }
    function setEditMode(m) { editMode = m; document.getElementById('modalTMain').className = `toggle-btn ${m==='main'?'active-main':''}`; document.getElementById('modalTBg').className = `toggle-btn ${m==='bg'?'active-bg':''}`; }
    function autoSize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function triggerImport() { document.getElementById('importFile').click(); }
    
    function exportData(onComplete = null) {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0]; 
        const timeStr = now.getHours().toString().padStart(2, '0') + '-' + 
                        now.getMinutes().toString().padStart(2, '0');
        const defaultName = `crhp_schedule_backup_${dateStr}_${timeStr}`;

        showModal(
            "Export Schedule",
            "Enter a name for your export file:",
            (userFileName) => {
                // If they cancel or close, we should still trigger the callback 
                // so the next modal (the wipe) can appear.
                if (userFileName === null || userFileName === false) {
                    if (onComplete) onComplete();
                    return;
                }

                userFileName = userFileName.replace(/\.json$/i, "").trim();
                const finalFileName = (userFileName || defaultName) + ".json";

                const dataToExport = {
                    tasks: tasks,
                    checklist: checklist,
                    roster: roster,
                    rooms: rooms,
                    totalDays: totalDays,
                    exportedAt: now.toLocaleString()
                };
                
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type:'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = finalFileName; 
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);

                // KEY: Run the next step only AFTER the download logic finishes
                if (onComplete) onComplete();
            },
            true, "Download", "info", "Cancel", true, defaultName
        );

        // Make Enter key work for the export input
        const input = document.getElementById('modal-input-field');
        if (input) {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('modal-ok').click();
            });
        }
    }
    
    function importData(e) {
        const file = e.target.files[0];
        if (!file) return;

        // 1. Ask for confirmation first, since this overwrites all current data
        showModal(
            "Import Schedule?",
            "This will replace all your current tasks, roster, and rooms with the data from this file. Are you sure?",
            (confirmed) => {
                if (!confirmed) return;

                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        
                        // Update global variables
                        tasks = d.tasks || [];
                        checklist = d.checklist || [];
                        roster = d.roster || [];
                        rooms = d.rooms || [];
                        totalDays = d.totalDays || 1;
                        
                        // Sync and Refresh UI
                        saveAll();
                        renderRoster();
                        renderRooms();
                        renderDays();
                        renderTasks();
                        
                        // 2. Success Modal
                        showModal("Import Successful", "Your schedule data has been loaded successfully.", null, false, "Great!");
                        
                    } catch(err) {
                        console.error(err);
                        // 3. Error Modal
                        showModal("Import Error", "The file provided is not a valid schedule JSON file.", null, false, "OK", "danger");
                    }
                };
                r.readAsText(file);
                
                // Clear the input so the same file can be imported again if needed
                e.target.value = '';
            },
            true, // isConfirm = true
            "Yes, Import",
            "info",
            "Cancel"
        );
    }

    
    function deleteDay(e, n) { 
        e.stopPropagation(); 

        // Replacement for the alert
        if (totalDays === 1) { 
            showModal(
                "Cannot Delete", 
                "You must have at least one day in your schedule.",
                null, 
                false, 
                "OK"
            );
            return; 
        } 

        // Replacement for the confirm
        showModal(
            "Delete Day?", 
            `Are you sure you want to delete Day ${n}? All tasks assigned to this day will be permanently removed.`,
            () => { 
                tasks = tasks.filter(t => t.day !== n); 
                tasks.forEach(t => { if (t.day > n) t.day--; }); 
                totalDays--; 
                currentDay = 1; 
                
                saveAll(); 
                renderDays(); 
                renderTasks(); 
                updateViewToggles(); 
            },
            true,
            "Delete Day",
            "danger",
            "Cancel"
        );
    }

    function deleteCheckItem(i) {
        // Check for .name here because that's what your addTask function uses
        const itemName = checklist[i].name || "this item";
        
        showModal(
            "Remove Item?", 
            `Are you sure you want to remove "${itemName}" from your checklist?`,
            () => {
                checklist.splice(i, 1);
                saveAll();
                renderChecklist();
            },
            true,
            "Remove",
            "danger",
            "Cancel"
        );
    }

    function renderEditRoster(assigned) {
        document.getElementById('modalRosterGrid').innerHTML = roster.map((p, i) => {
            const k = `${p.name} (${p.role})`;
            const isChecked = assigned.includes(k) ? 'checked' : '';
            
            return `
                <div class="roster-item" style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px;">
                    <div style="display: flex; align-items: center; flex: 1; cursor: pointer;" onclick="const ck=this.querySelector('input'); ck.checked=!ck.checked;">
                        <input type="checkbox" value="${k}" ${isChecked} onclick="event.stopPropagation()">
                        <span style="margin-left: 8px;">${p.name} <small style="color:var(--accent); font-weight:bold;">(${p.role})</small></span>
                    </div>
                    <span onclick="event.stopPropagation(); openRosterEdit(${i})" style="cursor: pointer; padding: 0 5px; opacity: 0.6; font-size: 14px;">âš™ï¸</span>
                </div>
            `;
        }).join('');
    }
    
    function deleteCurrentTask() {
        const isCheck = document.getElementById('modalHeader').innerText.includes("Checklist");
        
        // Both tasks and checklist items use .name based on your addTask function
        const itemArray = isCheck ? checklist : tasks;
        const displayName = itemArray[activeTaskIndex].name || (isCheck ? "this item" : "this task");

        showModal(
            `Delete ${isCheck ? 'Item' : 'Task'}?`,
            `Are you sure you want to remove "${displayName}"?`,
            () => {
                if (isCheck) {
                    checklist.splice(activeTaskIndex, 1);
                } else {
                    tasks.splice(activeTaskIndex, 1);
                }
                saveAll();
                isChecklistMode ? renderChecklist() : renderTasks();
                closeModal(false);
            },
            true,
            "Delete",
            "danger",
            "Cancel"
        );
    }

    function toggleHelp() {
        const modal = document.getElementById('helpModal');
        const body = document.body;
        
        // Change 'block' to 'flex' to maintain the centering alignment
        if (modal.style.display === 'flex') {
            modal.style.display = 'none';
            body.classList.remove('modal-open');
        } else {
            modal.style.display = 'flex';
            body.classList.add('modal-open');
        }
    }

    function renderAll() {
        renderRooms();
        renderRoster(); // or renderRosterCheckboxes()
        renderDays();
        if (isChecklistMode) {
            renderChecklist();
        } else {
            renderTasks();
        }
    }

    function initApp() {
        const hasData = localStorage.getItem('v50_tasks');
        // NEW: Check if the user explicitly wanted a blank slate
        const isBlankForced = localStorage.getItem('v50_is_blank');
        
        // Only load template if data is missing AND we haven't forced a blank start
        if ((!hasData || hasData === "null" || hasData === "[]") && isBlankForced !== "true") {
            console.log("No v50 data found. Loading master retreat template...");
            
            try {
                const data = JSON.parse(MASTER_TEMPLATE);
                tasks = data.tasks || [];
                checklist = data.checklist || [];
                roster = data.roster || [];
                rooms = data.rooms || [];
                totalDays = data.days || 1;
                saveAll(); 
            } catch (e) {
                console.error("Master Template Parse Error:", e);
            }
        } else {
            // Data exists (or user chose to be blank)
            tasks = JSON.parse(localStorage.getItem('v50_tasks')) || [];
            checklist = JSON.parse(localStorage.getItem('v50_checklist')) || [];
            roster = JSON.parse(localStorage.getItem('v50_roster')) || [];
            rooms = JSON.parse(localStorage.getItem('v50_rooms')) || [];
            totalDays = parseInt(localStorage.getItem('v50_days')) || 1;
        }
        
        renderAll(); 
    }

    function showModal(title, message, onConfirm = null, isConfirm = false, confirmText = "Confirm", type = "info", cancelText = "Cancel", includeInput = false, defaultInputValue = "") {
        const existing = document.getElementById('custom-modal-overlay');
        if (existing) existing.remove();

        const overlay = document.createElement('div');
        overlay.id = 'custom-modal-overlay';
        
        overlay.innerHTML = `
            <div class="modal-box ${type === 'danger' ? 'warning' : ''}">
                <h3>${title}</h3>
                <p>${message}</p>
                ${includeInput ? `
                    <input type="text" id="modal-input-field" class="modal-input" 
                        style="width:100%; margin-bottom:20px; background: #0f172a; color: white; border: 1px solid #334155; padding: 10px; border-radius: 6px;" 
                        value="${defaultInputValue}">
                ` : ''}
                <div class="modal-actions">
                    <button class="modal-btn btn-primary" id="modal-ok">${confirmText}</button>
                    ${isConfirm ? `<button class="modal-btn btn-secondary" id="modal-cancel">${cancelText}</button>` : ''}
                </div>
            </div>
        `;

        document.body.appendChild(overlay);

        // Focus input if it exists
        if (includeInput) {
            const input = document.getElementById('modal-input-field');
            input.focus();
            input.select(); // Highlight text for easy overwriting
        }

        document.getElementById('modal-ok').onclick = () => {
            let returnValue = true;
            if (includeInput) {
                returnValue = document.getElementById('modal-input-field').value;
            }
            overlay.remove();
            if (onConfirm) onConfirm(returnValue);
        };

        if (isConfirm && document.getElementById('modal-cancel')) {
            document.getElementById('modal-cancel').onclick = () => overlay.remove();
        }

        overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
    }

    function isModifiedFromMaster() {
        try {
            const master = JSON.parse(MASTER_TEMPLATE);
            
            // Stringify both to see if the content is exactly the same
            const currentData = JSON.stringify({
                tasks: tasks,
                checklist: checklist,
                roster: roster,
                rooms: rooms,
                days: totalDays
            });
            
            const masterData = JSON.stringify({
                tasks: master.tasks || [],
                checklist: master.checklist || [],
                roster: master.roster || [],
                rooms: master.rooms || [],
                days: master.days || 1
            });

            return currentData !== masterData;
        } catch (e) {
            return true; // If master is broken, assume modified to be safe
        }
    }

    function resetToMaster() {
        const hasData = tasks.length > 0 || roster.length > 0;
        const isModified = typeof isModifiedFromMaster === 'function' ? isModifiedFromMaster() : true;

        // Inner Function: The final "point of no return" step
        const proceedWithDelete = () => {
            showModal(
                "Wait! Final Warning", 
                "This will delete all names and edits and revert to the CRHP master template. Proceed?",
                () => {
                    try {
                        localStorage.removeItem('v50_is_blank');
                        const data = JSON.parse(MASTER_TEMPLATE);
                        
                        tasks = data.tasks || [];
                        checklist = data.checklist || [];
                        roster = data.roster || [];
                        rooms = data.rooms || [];
                        totalDays = data.days || 1;
                        
                        saveAll();
                        location.reload(); 
                    } catch (e) {
                        console.error("Error:", e);
                    }
                },
                true,
                "Yes, Reset Everything",
                "danger",   // Type
                "Keep My Data"    // False/Cancel label
            );
        };

        // Step 1: Check if we should offer a backup first
        if (hasData && isModified) {
            showModal(
                "Backup Edits?", 
                "Before resetting, would you like to download a backup of your current edits?",
                () => { 
                    exportData(() => proceedWithDelete());
                },
                true,
                "Download & Continue",
                "info",    // Type
                "No"       // False/Cancel label
            );
            
            // Ensure clicking "No" still leads to the Reset warning
            const cancelBtn = document.getElementById('modal-cancel');
            if (cancelBtn) {
                cancelBtn.onclick = () => {
                    document.getElementById('custom-modal-overlay').remove();
                    proceedWithDelete();
                };
            }
        } else {
            // No edits worth backing up, go straight to reset warning
            proceedWithDelete();
        }
    }

    function clearScheduleFresh() {
        const hasData = tasks.length > 0 || roster.length > 0;
        const isModified = typeof isModifiedFromMaster === 'function' ? isModifiedFromMaster() : true;

        const proceedWithWipe = () => {
            showModal(
                "Final Warning: Total Wipe", 
                "DANGER: This will delete ALL tasks, roster members, and rooms. Proceed?",
                () => {
                    tasks = []; checklist = []; roster = []; rooms = []; totalDays = 1;
                    localStorage.setItem('v50_is_blank', 'true');
                    saveAll();
                    location.reload(); 
                },
                true,
                "Delete Everything",
                "danger",
                "Keep My Data" // Custom Cancel Text
            );
        };

        if (hasData && isModified) {
            showModal(
                "Backup Edits?", 
                "Would you like to download a backup of your edits before wiping everything?",
                () => { 
                    exportData(() => proceedWithWipe());
                },
                true,
                "Yes, Download",
                "info",
                "No" // <--- Custom Cancel Text here!
            );

            // Manually hook the "No" button to proceed to wipe
            const cancelBtn = document.getElementById('modal-cancel');
            if(cancelBtn) {
                cancelBtn.onclick = () => {
                    document.getElementById('custom-modal-overlay').remove();
                    proceedWithWipe();
                };
            }
        } else {
            proceedWithWipe();
        }
    }

    function downloadBackup() {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.getHours().toString().padStart(2, '0') + 
                        now.getMinutes().toString().padStart(2, '0');
        const defaultName = `crhp_schedule_backup_${dateStr}_${timeStr}`;

        showModal(
            "Download Backup",
            "Enter a name for your backup file:",
            (userFileName) => {
                // This runs when they click 'Download' or press 'Enter'
                if (userFileName === null || userFileName === false) return;

                userFileName = userFileName.replace(/\.json$/i, "").trim();
                const finalFileName = (userFileName || defaultName) + ".json";

                const backupData = {
                    tasks: tasks,
                    checklist: checklist,
                    roster: roster,
                    rooms: rooms,
                    days: totalDays,
                    timestamp: now.toLocaleString()
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                link.href = url;
                link.download = finalFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            },
            true,           // isConfirm (show second button)
            "Download",     // confirmText (on the left)
            "info",         // type
            "Cancel",       // cancelText (on the right)
            true,           // includeInput
            defaultName     // defaultInputValue
        );

        // UX Add-on: Allow pressing "Enter" to trigger the download
        const modalInput = document.getElementById('modal-input-field');
        if (modalInput) {
            modalInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('modal-ok').click();
                }
            });
        }
    }


    function openPrintService() {
        const printData = {
            tasks: (typeof tasks !== 'undefined') ? tasks : [],
            checklist: (typeof checklist !== 'undefined') ? checklist : [],
            roster: (typeof roster !== 'undefined') ? roster : [],
            rooms: (typeof rooms !== 'undefined') ? rooms : [],
            totalDays: (typeof totalDays !== 'undefined') ? totalDays : 1
        };

        // 1. Open the window and capture the handle
        const printWindow = window.open('print-service.html', '_blank');
        
        // 2. Bring the new tab to the front
        if (printWindow) printWindow.focus();

        // 3. The "Handshake"
        const checkReady = setInterval(() => {
            // If user closed the window before it loaded, stop checking
            if (printWindow.closed) {
                clearInterval(checkReady);
                return;
            }

            // Push data to the new window
            printWindow.postMessage({ 
                type: 'PRINT_DATA', 
                payload: printData 
            }, '*');
        }, 500);

        // 4. Listen for a "Received" confirmation from the print-service to stop the interval
        window.addEventListener('message', function(event) {
            if (event.data === 'DATA_RECEIVED') {
                clearInterval(checkReady);
            }
        });

        // Safety timeout: stop trying after 10 seconds
        setTimeout(() => clearInterval(checkReady), 10000);
    }

    // Run this immediately when the Viewer loads
    window.addEventListener('load', () => {
        // Clear the print exchange so old data doesn't haunt the print service
        localStorage.removeItem('crhp_print_exchange');
        console.log("Print cache cleared for fresh session.");
    });


    // This is the trigger that actually starts the engine
    window.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Ready. Starting initApp...");
        initApp();
    });

    setInterval(updateNowLine, 30000);
    renderRoster();
	renderDays();
	renderTasks();
	setMode('main');
	renderRooms();
</script>
</body>
</html>
